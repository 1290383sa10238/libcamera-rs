use indoc::printdoc;
use libcamera_meta::{control_ids, property_ids, Control, ControlType};

fn format_docstring(desc: &str, indent: usize) -> String {
    desc.trim()
        .split("\n")
        .map(|line| format!("{}/// {}\n", " ".repeat(indent), line))
        .collect::<String>()
}

fn to_rust_type(t: ControlType) -> &'static str {
    match t {
        ControlType::Bool => "bool",
        ControlType::Byte => "u8",
        ControlType::Int32 => "i32",
        ControlType::Int64 => "i64",
        ControlType::Float => "f32",
        ControlType::String => "String",
        ControlType::Rectangle => "Rectangle",
        ControlType::Size => "Size",
    }
}

fn generate_controls(controls: &Vec<Control>, name: &str) {
    let mut i = 1;
    println!("pub enum {} {{", name);
    for ctrl in controls.iter() {
        print!("{}", format_docstring(&ctrl.description, 4));
        println!("    {} = {},", &ctrl.name, i);
        i += 1;
    }
    println!("}}\n");

    for ctrl in controls.iter() {
        let ctrl_name = &ctrl.name;
        let ctrl_type = to_rust_type(ctrl.typ);

        print!("{}", format_docstring(&ctrl.description, 0));
        if let Some(enumeration) = &ctrl.enumeration {
            let mut try_from = String::new();

            println!("#[derive(Debug, Clone)]");
            println!("pub enum {ctrl_name} {{");
            for val in enumeration {
                let var_name = val.name.replace(&ctrl.name, "");

                print!("{}", format_docstring(&val.description, 4));
                println!("    {var_name} = {},", val.value);
                try_from.push_str(&format!("{} => Ok(Self::{var_name}),\n", val.value));
            }
            println!("}}\n");

            let try_from = try_from.trim();
            printdoc! {"
                impl TryFrom<{ctrl_type}> for {ctrl_name} {{
                    type Error = ControlValueError;

                    fn try_from(value: {ctrl_type}) -> Result<Self, Self::Error> {{
                        match value {{
                            {try_from}
                            _ => Err(ControlValueError::InvalidData)
                        }}
                    }}
                }}

                impl Into<{ctrl_type}> for {ctrl_name} {{
                    fn into(self) -> {ctrl_type} {{
                        self as _
                    }}
                }}

                impl Control for {ctrl_name} {{
                    const ID: u32 = {name}::{ctrl_name} as _;
                    type T = {ctrl_type};
                }}\n
            "};
        } else {
            printdoc! {"
                #[derive(Debug, Clone)]
                pub struct {ctrl_name}(pub {ctrl_type});

                impl TryFrom<{ctrl_type}> for {ctrl_name} {{
                    type Error = ControlValueError;

                    fn try_from(value: {ctrl_type}) -> Result<Self, Self::Error> {{
                        Ok(Self(value))
                    }}
                }}

                impl Into<{ctrl_type}> for {ctrl_name} {{
                    fn into(self) -> {ctrl_type} {{
                        self.0
                    }}
                }}

                impl Control for {ctrl_name} {{
                    const ID: u32 = {name}::{ctrl_name} as _;
                    type T = {ctrl_type};
                }}\n
            "};
        }
    }
}

fn main() {
    let args = std::env::args().collect::<Vec<_>>();
    match args.get(1).map(String::as_str) {
        Some("controls") => {
            println!("//! Generated by `cargo run --bin generate_rust controls`\n");
            println!("use crate::control::Control;");
            println!("#[allow(unused_imports)]");
            println!("use crate::control_value::{{ControlValueError, Rectangle, Size}};\n");
            let controls = control_ids();
            generate_controls(&controls, "ControlId");
        }
        Some("properties") => {
            println!("//! Generated by `cargo run --bin generate_rust properties`\n");
            println!("use crate::control::Control;");
            println!("#[allow(unused_imports)]");
            println!("use crate::control_value::{{ControlValueError, Rectangle, Size}};\n");
            let properties = property_ids();
            generate_controls(&properties, "PropertyId");
        }
        _ => {
            eprintln!("Usage: generate_rust [controls|properties]")
        }
    }
}
